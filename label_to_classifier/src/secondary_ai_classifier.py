#!/usr/bin/env python3
"""
ğŸ¤– äºŒçº§AIæ™ºèƒ½èšç±»åˆ†ç±»å™¨ - Secondary AI Intelligent Clustering Classifier
ç»Ÿä¸€æ¶æ„è®¾è®¡ï¼šç»§æ‰¿BaseAIClassifierï¼Œä¸“æ³¨äºŒçº§æ ‡ç­¾åˆ†ç±»

v3.0 åŠŸèƒ½:
- ç»§æ‰¿ç»Ÿä¸€çš„BaseAIClassifieræ¶æ„
- ä¸“æ³¨äºŒçº§æ ‡ç­¾åˆ†ç±»ä¸šåŠ¡é€»è¾‘
- åŸºäºå·²æœ‰ä¸»æ ‡ç­¾è¿›è¡ŒäºŒçº§AIåˆ†æ
- åŠ¨æ€å­ç±»åˆ«è¯†åˆ«ï¼Œä¸ä¾èµ–ç¡¬ç¼–ç è§„åˆ™
- æ™ºèƒ½ç½®ä¿¡åº¦è¯„ä¼°
"""

import os
import sys
import json
import logging
from pathlib import Path
from typing import Dict, List, Optional, Tuple, Any

# ç»§æ‰¿BaseAIClassifier
try:
    from .base_ai_classifier import BaseAIClassifier
    from .unified_ai_config_manager import TaskType
except ImportError:
    # æ”¯æŒç›´æ¥è¿è¡Œæµ‹è¯•
    from base_ai_classifier import BaseAIClassifier
    from unified_ai_config_manager import TaskType

# è®¾ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class SecondaryAIClassifier(BaseAIClassifier):
    """äºŒçº§AIæ™ºèƒ½èšç±»åˆ†ç±»å™¨ v3.0 - ç»§æ‰¿ç»Ÿä¸€åˆ†ç±»å™¨æ¶æ„"""
    
    def __init__(self):
        """åˆå§‹åŒ–äºŒçº§AIåˆ†ç±»å™¨ - ç»§æ‰¿BaseAIClassifier"""
        
        # åˆå§‹åŒ–åŸºç±»
        super().__init__(TaskType.SECONDARY_TAG_CLASSIFICATION)
        
        # äºŒçº§åˆ†ç±»ç‰¹å®šé…ç½® - æ”¯æŒå“ç‰ŒåŒ–äº§å“ä»‹ç»åˆ†ç±»
        self.main_categories = {
            "ğŸª é’©å­": ["é—®é¢˜æè¿°", "ä¸“å®¶å»ºè®®", "ç„¦è™‘è¡¨è¾¾", "è§£å†³æ–¹æ¡ˆ"],
            "ğŸ¼ äº§å“ä»‹ç»_è•´æ·³": ["äº§å“å±•ç¤º", "è¥å…»ç§‘å­¦", "ä¸“ä¸šè®¤è¯", "æˆåˆ†è¡¨è¯†åˆ«", "A2æ ‡ç­¾è¯†åˆ«", "HMOåŠŸæ•ˆ", "ä½¿ç”¨æ¼”ç¤º"],
            "ğŸ¼ äº§å“ä»‹ç»_æ°´å¥¶": ["äº§å“å±•ç¤º", "ä¾¿æºç‰¹æ€§", "å³é¥®æ¼”ç¤º", "å¥¶æºä»‹ç»", "æ–°é²œå“è´¨", "ä½¿ç”¨æ¼”ç¤º"],
            "ğŸ¼ äº§å“ä»‹ç»_è“é’»": ["äº§å“å±•ç¤º", "é«˜ç«¯é…æ–¹", "ä¸“ä¸šè®¤è¯", "å‡çº§ç‰¹æ€§", "è¥å…»ç§‘å­¦", "ä½¿ç”¨æ¼”ç¤º"],
            "ğŸŒŸ ä½¿ç”¨æ•ˆæœ": ["å®å®æˆé•¿", "ä½¿ç”¨åœºæ™¯", "æ•ˆæœå¯¹æ¯”", "æ»¡æ„åé¦ˆ", "å¥åº·æŒ‡æ ‡"],
            "ğŸ ä¿ƒé”€æœºåˆ¶": ["æ¬¢ä¹ç¬é—´", "æ¸©é¦¨æ—¥å¸¸", "å¥åº·æ´»åŠ›", "æƒ…æ„Ÿè¿æ¥"]
        }
        
        logger.info(f"âœ… äºŒçº§AIæ™ºèƒ½èšç±»åˆ†ç±»å™¨åˆå§‹åŒ–å®Œæˆ")
        logger.info(f"ğŸ¯ æ”¯æŒä¸»ç±»åˆ«: {', '.join(self.main_categories.keys())}")

    def _build_classification_prompts(self) -> Dict[str, str]:
        """æ„å»ºäºŒçº§åˆ†ç±»æç¤ºè¯"""
        return {
            "ğŸª é’©å­": """ğŸ¯ ä½ æ˜¯ä¸“ä¸šçš„æ¯å©´è§†é¢‘äºŒçº§èšç±»åˆ†æä¸“å®¶ï¼Œä¸“é—¨å¯¹"ï¿½ï¿½ é’©å­"ç±»åˆ«è¿›è¡Œç²¾å‡†çš„å­åˆ†ç±»ã€‚

## ğŸ¬ å¤šé•œå¤´è§†é¢‘åˆ†ææŒ‡å¯¼

**å¤šé•œå¤´è§†é¢‘å¤„ç†åŸåˆ™**ï¼š
- å½“è§†é¢‘åŒ…å«å¤šä¸ªåœºæ™¯æ—¶ï¼Œé‡ç‚¹åˆ†æ**ä¸»å¯¼åœºæ™¯**å’Œ**æ ¸å¿ƒä¿¡æ¯**
- ä¼˜å…ˆè€ƒè™‘**å ç”¨æ—¶é—´æœ€é•¿**æˆ–**æœ€çªå‡º**çš„å†…å®¹
- å…³æ³¨è§†é¢‘çš„**ä¸»è¦æ„å›¾**å’Œ**æ ¸å¿ƒä¿¡æ¯ä¼ è¾¾**
- å¦‚æœåŒ…å«å¤šä¸ªä¸åŒå­ç±»åˆ«ï¼Œé€‰æ‹©**æœ€èƒ½ä»£è¡¨è§†é¢‘ä¸»é¢˜**çš„åˆ†ç±»

## ğŸ“‹ é’©å­ç±»åˆ«çš„å­åˆ†ç±»ä½“ç³»

**é—®é¢˜æè¿°**: ç›´æ¥æè¿°å®å®æˆ–è‚²å„¿é—®é¢˜çš„åœºæ™¯
- å…³é”®ç‰¹å¾ï¼šå®å®å“­é—¹ã€ä¸é€‚ã€ç¡çœ é—®é¢˜ã€æ¶ˆåŒ–é—®é¢˜ã€å‘è‚²æ‹…å¿§
- å…¸å‹è¡¨ç°ï¼šå±•ç¤ºå…·ä½“çš„é—®é¢˜æƒ…å†µï¼Œè¥é€ éœ€è¦è§£å†³çš„æ°›å›´
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘ä¸»è¦å±•ç¤ºé—®é¢˜åœºæ™¯ï¼Œå³ä½¿åŒ…å«å…¶ä»–å†…å®¹ä¹Ÿå½’æ­¤ç±»

**ä¸“å®¶å»ºè®®**: æƒå¨ä¸“å®¶æä¾›çš„ä¸“ä¸šæŒ‡å¯¼å’Œå»ºè®®
- å…³é”®ç‰¹å¾ï¼šåŒ»ç”Ÿå‡ºé•œã€ä¸“å®¶è§£é‡Šã€ç§‘å­¦ä¾æ®ã€ä¸“ä¸šæœ¯è¯­
- å…¸å‹è¡¨ç°ï¼šç™½è¡£ä¸“å®¶ã€æƒå¨èƒŒä¹¦ã€ç§‘å­¦ç ”ç©¶å¼•ç”¨
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘æ ¸å¿ƒæ˜¯ä¸“å®¶è®²è§£ï¼Œå…¶ä»–åœºæ™¯ä¸ºè¾…åŠ©å†…å®¹

**ç„¦è™‘è¡¨è¾¾**: å®¶é•¿å†…å¿ƒç„¦è™‘å’Œå›°æƒ‘çš„æƒ…æ„Ÿè¡¨è¾¾
- å…³é”®ç‰¹å¾ï¼šå®¶é•¿å›°æƒ‘ã€ä¸çŸ¥æ‰€æªã€æ‹…å¿ƒã€å¯»æ±‚å¸®åŠ©
- å…¸å‹è¡¨ç°ï¼šå®¶é•¿è‡ªè¿°ã€æƒ…æ„Ÿè¡¨è¾¾ã€æ±‚åŠ©å¿ƒæ€
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘ä¸»è¦ä¼ è¾¾å®¶é•¿çš„ç„¦è™‘æƒ…ç»ª

**è§£å†³æ–¹æ¡ˆ**: é’ˆå¯¹é—®é¢˜æå‡ºçš„å…·ä½“è§£å†³åŠæ³•
- å…³é”®ç‰¹å¾ï¼šæä¾›æ–¹æ³•ã€æ­¥éª¤æŒ‡å¯¼ã€æ”¹å–„å»ºè®®ã€è¡ŒåŠ¨æŒ‡å—
- å…¸å‹è¡¨ç°ï¼šæ“ä½œæ¼”ç¤ºã€æ–¹æ³•è¯´æ˜ã€æ”¹å–„å¯¹æ¯”
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘ä¸»è¦ç›®çš„æ˜¯æä¾›è§£å†³æ–¹æ¡ˆ

## ğŸ“ è¾“å‡ºæ ¼å¼è¦æ±‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š

```json
{
    "secondary_category": "å­åˆ†ç±»åç§°",
    "confidence": ç½®ä¿¡åº¦åˆ†æ•°(0.0-1.0),
    "reasoning": "åˆ†ç±»ä¾æ®çš„è¯¦ç»†è¯´æ˜",
    "matched_features": ["åŒ¹é…åˆ°çš„å…³é”®ç‰¹å¾"],
    "multi_scene_analysis": "å¦‚æœæ˜¯å¤šé•œå¤´è§†é¢‘ï¼Œè¯´æ˜é€‰æ‹©æ­¤åˆ†ç±»çš„åŸå› "
}
```

è¯·åˆ†æä»¥ä¸‹Labelså†…å®¹ï¼š""",
            
            "ğŸ¼ äº§å“ä»‹ç»_è•´æ·³": """ğŸ¯ ä½ æ˜¯ä¸“ä¸šçš„æ¯å©´è§†é¢‘äºŒçº§èšç±»åˆ†æä¸“å®¶ï¼Œä¸“é—¨å¯¹"ğŸ¼ äº§å“ä»‹ç»_è•´æ·³"ç±»åˆ«è¿›è¡Œç²¾å‡†çš„å­åˆ†ç±»ã€‚

## ğŸ¬ å¤šé•œå¤´è§†é¢‘åˆ†ææŒ‡å¯¼

**å¤šé•œå¤´è§†é¢‘å¤„ç†åŸåˆ™**ï¼š
- å½“è§†é¢‘åŒ…å«å¤šä¸ªåœºæ™¯æ—¶ï¼Œé‡ç‚¹åˆ†æ**ä¸»å¯¼åœºæ™¯**å’Œ**æ ¸å¿ƒä¿¡æ¯**
- ä¼˜å…ˆè€ƒè™‘**å ç”¨æ—¶é—´æœ€é•¿**æˆ–**æœ€çªå‡º**çš„å†…å®¹
- å…³æ³¨è§†é¢‘çš„**ä¸»è¦æ„å›¾**å’Œ**æ ¸å¿ƒä¿¡æ¯ä¼ è¾¾**
- å¦‚æœåŒ…å«å¤šä¸ªä¸åŒå­ç±»åˆ«ï¼Œé€‰æ‹©**æœ€èƒ½ä»£è¡¨è§†é¢‘ä¸»é¢˜**çš„åˆ†ç±»

## ğŸ“‹ äº§å“ä»‹ç»_è•´æ·³çš„å­åˆ†ç±»ä½“ç³»

**äº§å“å±•ç¤º**: ç›´è§‚å±•ç¤ºå¯èµ‹è•´æ·³äº§å“å¤–è§‚å’ŒåŒ…è£…
- å…³é”®ç‰¹å¾ï¼šäº§å“åŒ…è£…ã€å¤–è§‚å±•ç¤ºã€å“ç‰Œæ ‡è¯†
- å…¸å‹è¡¨ç°ï¼šäº§å“é™æ€å±•ç¤ºã€åŒ…è£…è®¾è®¡ã€å“ç‰Œå…ƒç´ 
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘ä¸»è¦å±•ç¤ºäº§å“å¤–è§‚ï¼Œå…¶ä»–åœºæ™¯ä¸ºè¾…åŠ©

**è¥å…»ç§‘å­¦**: é‡ç‚¹ä»‹ç»è•´æ·³çš„è¥å…»æˆåˆ†å’Œç§‘å­¦é…æ–¹
- å…³é”®ç‰¹å¾ï¼šHMOã€æ¯ä¹³ä½èšç³–ã€OPNã€Î±-ä¹³æ¸…è›‹ç™½ã€è¥å…»é…æ–¹
- å…¸å‹è¡¨ç°ï¼šæˆåˆ†ä»‹ç»ã€ç§‘å­¦ç ”ç©¶ã€è¥å…»ä»·å€¼è¯´æ˜
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘æ ¸å¿ƒæ˜¯è¥å…»ç§‘å­¦çŸ¥è¯†ä¼ è¾¾

**ä¸“ä¸šè®¤è¯**: å¼ºè°ƒæƒå¨èƒŒä¹¦å’Œä¸“ä¸šè®¤è¯
- å…³é”®ç‰¹å¾ï¼šæƒå¨æœºæ„ã€ä¸“ä¸šè®¤è¯ã€ç§‘ç ”èƒŒæ™¯ã€æƒ æ°å“ç‰Œ
- å…¸å‹è¡¨ç°ï¼šè®¤è¯æ ‡è¯†ã€ä¸“ä¸šèƒŒä¹¦ã€å“ç‰Œæƒå¨æ€§
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘ä¸»è¦ä¼ è¾¾æƒå¨æ€§å’Œä¸“ä¸šæ€§

**æˆåˆ†è¡¨è¯†åˆ«**: è¯¦ç»†å±•ç¤ºå’Œè§£è¯»äº§å“æˆåˆ†æ ‡ç­¾
- å…³é”®ç‰¹å¾ï¼šæˆåˆ†è¡¨ã€è¥å…»æ ‡ç­¾ã€é…æ–¹è¯´æ˜ã€å«é‡æ ‡è¯†
- å…¸å‹è¡¨ç°ï¼šæˆåˆ†è¡¨å±•ç¤ºã€æ ‡ç­¾è§£è¯»ã€é…æ–¹åˆ†æ
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘ä¸»è¦å±•ç¤ºæˆåˆ†ä¿¡æ¯

**A2æ ‡ç­¾è¯†åˆ«**: ä¸“é—¨è¯†åˆ«A2è›‹ç™½ç›¸å…³å†…å®¹
- å…³é”®ç‰¹å¾ï¼šA2è›‹ç™½ã€A2å¥¶æºã€A2æ ‡è¯†ã€è›‹ç™½è´¨ç±»å‹
- å…¸å‹è¡¨ç°ï¼šA2è›‹ç™½è¯´æ˜ã€å¥¶æºä»‹ç»ã€è›‹ç™½è´¨ä¼˜åŠ¿
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘é‡ç‚¹ä»‹ç»A2è›‹ç™½ç‰¹æ€§

**HMOåŠŸæ•ˆ**: ä¸“æ³¨æ¯ä¹³ä½èšç³–åŠŸæ•ˆå’Œä½œç”¨
- å…³é”®ç‰¹å¾ï¼šHMOã€æ¯ä¹³ä½èšç³–ã€å…ç–«åŠ›ã€è‚ é“å¥åº·
- å…¸å‹è¡¨ç°ï¼šHMOä½œç”¨æœºåˆ¶ã€å¥åº·ç›Šå¤„ã€ç§‘å­¦åŸç†
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘æ ¸å¿ƒæ˜¯HMOåŠŸæ•ˆè¯´æ˜

**ä½¿ç”¨æ¼”ç¤º**: å±•ç¤ºäº§å“çš„ä½¿ç”¨æ–¹æ³•å’Œå†²è°ƒè¿‡ç¨‹
- å…³é”®ç‰¹å¾ï¼šå†²è°ƒæ¼”ç¤ºã€ä½¿ç”¨æ–¹æ³•ã€æ“ä½œæ­¥éª¤
- å…¸å‹è¡¨ç°ï¼šå†²æ³¡è¿‡ç¨‹ã€ä½¿ç”¨æŒ‡å¯¼ã€æ“ä½œæ¼”ç¤º
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘ä¸»è¦å±•ç¤ºä½¿ç”¨æ–¹æ³•

## ğŸ“ è¾“å‡ºæ ¼å¼è¦æ±‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š

```json
{
    "secondary_category": "å­åˆ†ç±»åç§°",
    "confidence": ç½®ä¿¡åº¦åˆ†æ•°(0.0-1.0),
    "reasoning": "åˆ†ç±»ä¾æ®çš„è¯¦ç»†è¯´æ˜",
    "matched_features": ["åŒ¹é…åˆ°çš„å…³é”®ç‰¹å¾"],
    "multi_scene_analysis": "å¦‚æœæ˜¯å¤šé•œå¤´è§†é¢‘ï¼Œè¯´æ˜é€‰æ‹©æ­¤åˆ†ç±»çš„åŸå› "
}
```

è¯·åˆ†æä»¥ä¸‹Labelså†…å®¹ï¼š""",
            
            "ğŸ¼ äº§å“ä»‹ç»_æ°´å¥¶": """ğŸ¯ ä½ æ˜¯ä¸“ä¸šçš„æ¯å©´è§†é¢‘äºŒçº§èšç±»åˆ†æä¸“å®¶ï¼Œä¸“é—¨å¯¹"ğŸ¼ äº§å“ä»‹ç»_æ°´å¥¶"ç±»åˆ«è¿›è¡Œç²¾å‡†çš„å­åˆ†ç±»ã€‚

## ğŸ“‹ æ°´å¥¶äº§å“ä»‹ç»ç±»åˆ«çš„å­åˆ†ç±»ä½“ç³»

**äº§å“å±•ç¤º**: å¯èµ‹æ°´å¥¶äº§å“å¤–è§‚ã€ä¾¿æºåŒ…è£…çš„ç›´è§‚å±•ç¤º
- å…³é”®ç‰¹å¾ï¼šæ°´å¥¶åŒ…è£…ã€å°ç“¶è£…ã€ä¾¿æºè®¾è®¡ã€äº§å“å¤–è§‚

**ä¾¿æºç‰¹æ€§**: æ°´å¥¶ä¾¿æºè£…çš„ç‰¹æ€§å’Œä¼˜åŠ¿ä»‹ç»
- å…³é”®ç‰¹å¾ï¼šä¾¿æºè£…ã€å°ç“¶è£…ã€æºå¸¦æ–¹ä¾¿ã€ä¾¿åˆ©æ€§ã€å¤–å‡ºé€‚ç”¨

**å³é¥®æ¼”ç¤º**: æ°´å¥¶å³å¼€å³é¥®çš„ä¾¿åˆ©æ€§æ¼”ç¤º
- å…³é”®ç‰¹å¾ï¼šå³é¥®ã€å³å¼€å³ç”¨ã€ä¾¿åˆ©æ€§ã€ä½¿ç”¨ç®€å•ã€å¿«é€Ÿ

**å¥¶æºä»‹ç»**: æ°´å¥¶çš„å¥¶æºå“è´¨å’Œæ–°é²œåº¦ä»‹ç»
- å…³é”®ç‰¹å¾ï¼šå¥¶æºã€æ–°é²œå“è´¨ã€æ¶²ä½“å¥¶ã€å“è´¨ä¿è¯

**æ–°é²œå“è´¨**: æ°´å¥¶çš„æ–°é²œåº¦å’Œå“è´¨ä¿è¯å±•ç¤º
- å…³é”®ç‰¹å¾ï¼šæ–°é²œåº¦ã€å“è´¨ä¿è¯ã€å³å¼€å³é¥®ã€æ¶²ä½“

**ä½¿ç”¨æ¼”ç¤º**: æ°´å¥¶äº§å“çš„ä½¿ç”¨åœºæ™¯å’Œæ–¹æ³•æ¼”ç¤º
- å…³é”®ç‰¹å¾ï¼šä½¿ç”¨åœºæ™¯ã€å¤–å‡ºä½¿ç”¨ã€æ—¥å¸¸ä½¿ç”¨ã€ä¾¿åˆ©æ€§å±•ç¤º

## ğŸ“ è¾“å‡ºæ ¼å¼è¦æ±‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š

```json
{
    "secondary_category": "å­åˆ†ç±»åç§°",
    "confidence": ç½®ä¿¡åº¦åˆ†æ•°(0.0-1.0),
    "reasoning": "åˆ†ç±»ä¾æ®çš„è¯¦ç»†è¯´æ˜",
    "matched_features": ["åŒ¹é…åˆ°çš„å…³é”®ç‰¹å¾"]
}
```

è¯·åˆ†æä»¥ä¸‹Labelså†…å®¹ï¼š""",
            
            "ğŸ¼ äº§å“ä»‹ç»_è“é’»": """ğŸ¯ ä½ æ˜¯ä¸“ä¸šçš„æ¯å©´è§†é¢‘äºŒçº§èšç±»åˆ†æä¸“å®¶ï¼Œä¸“é—¨å¯¹"ğŸ¼ äº§å“ä»‹ç»_è“é’»"ç±»åˆ«è¿›è¡Œç²¾å‡†çš„å­åˆ†ç±»ã€‚

## ğŸ“‹ è“é’»äº§å“ä»‹ç»ç±»åˆ«çš„å­åˆ†ç±»ä½“ç³»

**äº§å“å±•ç¤º**: å¯èµ‹è“é’»é«˜ç«¯äº§å“å¤–è§‚ã€åŒ…è£…çš„ç›´è§‚å±•ç¤º
- å…³é”®ç‰¹å¾ï¼šè“é’»åŒ…è£…ã€é«˜ç«¯è®¾è®¡ã€å“ç‰Œæ ‡è¯†ã€æ——èˆ°äº§å“

**é«˜ç«¯é…æ–¹**: è“é’»å‡çº§é…æ–¹å’Œé«˜ç«¯æˆåˆ†çš„ä»‹ç»
- å…³é”®ç‰¹å¾ï¼šå‡çº§é…æ–¹ã€é«˜ç«¯æˆåˆ†ã€è¿›é˜¶é…æ–¹ã€ä¼˜åŒ–é…æ–¹

**ä¸“ä¸šè®¤è¯**: è“é’»äº§å“çš„ä¸“ä¸šèƒŒæ™¯å’Œé«˜ç«¯è®¤è¯
- å…³é”®ç‰¹å¾ï¼šä¸“ä¸šè®¤è¯ã€é«˜ç«¯è®¤è¯ã€æƒå¨èƒŒä¹¦ã€å“è´¨ä¿è¯

**å‡çº§ç‰¹æ€§**: è“é’»ç³»åˆ—çš„å‡çº§ç‰¹æ€§å’Œæ”¹è¿›ç‚¹
- å…³é”®ç‰¹å¾ï¼šå‡çº§ç‰¹æ€§ã€æ”¹è¿›ä¼˜åŒ–ã€å¢å¼ºåŠŸèƒ½ã€æå‡å“è´¨

**è¥å…»ç§‘å­¦**: è“é’»äº§å“è¥å…»æˆåˆ†å’Œç§‘å­¦åŸç†çš„æ·±åº¦ä»‹ç»
- å…³é”®ç‰¹å¾ï¼šè¥å…»ç§‘å­¦ã€é«˜ç«¯è¥å…»ã€ç§‘å­¦é…æ–¹ã€è¥å…»å‡çº§

**ä½¿ç”¨æ¼”ç¤º**: è“é’»äº§å“çš„é«˜ç«¯ä½¿ç”¨ä½“éªŒæ¼”ç¤º
- å…³é”®ç‰¹å¾ï¼šä½¿ç”¨æ¼”ç¤ºã€é«˜ç«¯ä½“éªŒã€å“è´¨ä½“éªŒã€ä½¿ç”¨æ–¹æ³•

## ğŸ“ è¾“å‡ºæ ¼å¼è¦æ±‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š

```json
{
    "secondary_category": "å­åˆ†ç±»åç§°",
    "confidence": ç½®ä¿¡åº¦åˆ†æ•°(0.0-1.0),
    "reasoning": "åˆ†ç±»ä¾æ®çš„è¯¦ç»†è¯´æ˜",
    "matched_features": ["åŒ¹é…åˆ°çš„å…³é”®ç‰¹å¾"]
}
```

è¯·åˆ†æä»¥ä¸‹Labelså†…å®¹ï¼š""",
            
            "ğŸŒŸ ä½¿ç”¨æ•ˆæœ": """ğŸ¯ ä½ æ˜¯ä¸“ä¸šçš„æ¯å©´è§†é¢‘äºŒçº§èšç±»åˆ†æä¸“å®¶ï¼Œä¸“é—¨å¯¹"ğŸŒŸ ä½¿ç”¨æ•ˆæœ"ç±»åˆ«è¿›è¡Œç²¾å‡†çš„å­åˆ†ç±»ã€‚

## ğŸ¬ å¤šé•œå¤´è§†é¢‘åˆ†ææŒ‡å¯¼

**å¤šé•œå¤´è§†é¢‘å¤„ç†åŸåˆ™**ï¼š
- å½“è§†é¢‘åŒ…å«å¤šä¸ªåœºæ™¯æ—¶ï¼Œé‡ç‚¹åˆ†æ**ä¸»å¯¼åœºæ™¯**å’Œ**æ ¸å¿ƒä¿¡æ¯**
- ä¼˜å…ˆè€ƒè™‘**å ç”¨æ—¶é—´æœ€é•¿**æˆ–**æœ€çªå‡º**çš„å†…å®¹
- å…³æ³¨è§†é¢‘çš„**ä¸»è¦æ„å›¾**å’Œ**æ ¸å¿ƒä¿¡æ¯ä¼ è¾¾**
- å¦‚æœåŒ…å«å¤šä¸ªä¸åŒå­ç±»åˆ«ï¼Œé€‰æ‹©**æœ€èƒ½ä»£è¡¨è§†é¢‘ä¸»é¢˜**çš„åˆ†ç±»

## ğŸ“‹ ä½¿ç”¨æ•ˆæœç±»åˆ«çš„å­åˆ†ç±»ä½“ç³»

**å®å®æˆé•¿**: å±•ç¤ºå®å®å¥åº·å‘è‚²å’Œæˆé•¿çŠ¶å†µ
- å…³é”®ç‰¹å¾ï¼šå®å®å‘è‚²ã€æˆé•¿è¿›æ­¥ã€å¥åº·çŠ¶å†µã€å‘è‚²æŒ‡æ ‡
- å…¸å‹è¡¨ç°ï¼šå®å®æ´»æ³¼ã€å¥åº·æˆé•¿ã€å‘è‚²è‰¯å¥½
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘ä¸»è¦å±•ç¤ºå®å®çš„æˆé•¿æ•ˆæœ

**ä½¿ç”¨åœºæ™¯**: å±•ç¤ºæ—¥å¸¸ä½¿ç”¨äº§å“çš„çœŸå®åœºæ™¯
- å…³é”®ç‰¹å¾ï¼šæ—¥å¸¸ä½¿ç”¨ã€ç”Ÿæ´»åœºæ™¯ã€å®é™…åº”ç”¨ã€ä½¿ç”¨ç¯å¢ƒ
- å…¸å‹è¡¨ç°ï¼šå®¶åº­ä½¿ç”¨ã€æ—¥å¸¸å–‚å…»ã€çœŸå®åœºæ™¯
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘æ ¸å¿ƒæ˜¯å±•ç¤ºä½¿ç”¨åœºæ™¯

**æ•ˆæœå¯¹æ¯”**: å±•ç¤ºä½¿ç”¨å‰åçš„æ˜æ˜¾å¯¹æ¯”
- å…³é”®ç‰¹å¾ï¼šå‰åå¯¹æ¯”ã€æ”¹å–„æ•ˆæœã€æ˜æ˜¾å˜åŒ–ã€æ•ˆæœå±•ç¤º
- å…¸å‹è¡¨ç°ï¼šå¯¹æ¯”å±•ç¤ºã€æ•ˆæœæ˜æ˜¾ã€æ”¹å–„æ˜¾è‘—
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘ä¸»è¦å±•ç¤ºå¯¹æ¯”æ•ˆæœ

**æ»¡æ„åé¦ˆ**: å±•ç¤ºç”¨æˆ·çš„æ»¡æ„åº¦å’Œæ­£é¢åé¦ˆ
- å…³é”®ç‰¹å¾ï¼šç”¨æˆ·æ»¡æ„ã€æ­£é¢åé¦ˆã€æ¨èã€å¥½è¯„
- å…¸å‹è¡¨ç°ï¼šæ»¡æ„è¡¨è¾¾ã€æ¨èäº§å“ã€æ­£é¢è¯„ä»·
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘ä¸»è¦ä¼ è¾¾æ»¡æ„åº¦

**å¥åº·æŒ‡æ ‡**: å±•ç¤ºå…·ä½“çš„å¥åº·æ•°æ®å’ŒæŒ‡æ ‡
- å…³é”®ç‰¹å¾ï¼šå¥åº·æ•°æ®ã€æŒ‡æ ‡æ”¹å–„ã€åŒ»å­¦æŒ‡æ ‡ã€å¥åº·çŠ¶å†µ
- å…¸å‹è¡¨ç°ï¼šå¥åº·æ£€æŸ¥ã€æŒ‡æ ‡æ•°æ®ã€åŒ»å­¦è¯æ˜
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘é‡ç‚¹å±•ç¤ºå¥åº·æŒ‡æ ‡

## ğŸ“ è¾“å‡ºæ ¼å¼è¦æ±‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š

```json
{
    "secondary_category": "å­åˆ†ç±»åç§°",
    "confidence": ç½®ä¿¡åº¦åˆ†æ•°(0.0-1.0),
    "reasoning": "åˆ†ç±»ä¾æ®çš„è¯¦ç»†è¯´æ˜",
    "matched_features": ["åŒ¹é…åˆ°çš„å…³é”®ç‰¹å¾"],
    "multi_scene_analysis": "å¦‚æœæ˜¯å¤šé•œå¤´è§†é¢‘ï¼Œè¯´æ˜é€‰æ‹©æ­¤åˆ†ç±»çš„åŸå› "
}
```

è¯·åˆ†æä»¥ä¸‹Labelså†…å®¹ï¼š""",
            
            "ğŸ ä¿ƒé”€æœºåˆ¶": """ğŸ¯ ä½ æ˜¯ä¸“ä¸šçš„æ¯å©´è§†é¢‘äºŒçº§èšç±»åˆ†æä¸“å®¶ï¼Œä¸“é—¨å¯¹"ğŸ ä¿ƒé”€æœºåˆ¶"ç±»åˆ«è¿›è¡Œç²¾å‡†çš„å­åˆ†ç±»ã€‚

## ğŸ¬ å¤šé•œå¤´è§†é¢‘åˆ†ææŒ‡å¯¼

**å¤šé•œå¤´è§†é¢‘å¤„ç†åŸåˆ™**ï¼š
- å½“è§†é¢‘åŒ…å«å¤šä¸ªåœºæ™¯æ—¶ï¼Œé‡ç‚¹åˆ†æ**ä¸»å¯¼åœºæ™¯**å’Œ**æ ¸å¿ƒä¿¡æ¯**
- ä¼˜å…ˆè€ƒè™‘**å ç”¨æ—¶é—´æœ€é•¿**æˆ–**æœ€çªå‡º**çš„å†…å®¹
- å…³æ³¨è§†é¢‘çš„**ä¸»è¦æ„å›¾**å’Œ**æ ¸å¿ƒä¿¡æ¯ä¼ è¾¾**
- å¦‚æœåŒ…å«å¤šä¸ªä¸åŒå­ç±»åˆ«ï¼Œé€‰æ‹©**æœ€èƒ½ä»£è¡¨è§†é¢‘ä¸»é¢˜**çš„åˆ†ç±»

## ğŸ“‹ ä¿ƒé”€æœºåˆ¶ç±»åˆ«çš„å­åˆ†ç±»ä½“ç³»

**æ¬¢ä¹ç¬é—´**: å±•ç¤ºå¿«ä¹ã€å–œæ‚¦çš„ç¾å¥½æ—¶åˆ»
- å…³é”®ç‰¹å¾ï¼šå¿«ä¹ã€æ¬¢ä¹ã€å–œæ‚¦ã€ç¾å¥½æ—¶åˆ»
- å…¸å‹è¡¨ç°ï¼šå®å®å¼€å¿ƒã€å®¶åº­æ¬¢ä¹ã€æ„‰å¿«åœºæ™¯
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘ä¸»è¦ä¼ è¾¾æ¬¢ä¹æ°›å›´

**æ¸©é¦¨æ—¥å¸¸**: å±•ç¤ºæ¸©æš–ã€å’Œè°çš„æ—¥å¸¸ç”Ÿæ´»
- å…³é”®ç‰¹å¾ï¼šæ¸©é¦¨ã€å’Œè°ã€æ—¥å¸¸ç”Ÿæ´»ã€å®¶åº­æ¸©æš–
- å…¸å‹è¡¨ç°ï¼šå®¶åº­æ¸©é¦¨ã€æ—¥å¸¸åœºæ™¯ã€å’Œè°æ°›å›´
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘æ ¸å¿ƒæ˜¯æ¸©é¦¨æ—¥å¸¸åœºæ™¯

**å¥åº·æ´»åŠ›**: å±•ç¤ºå¥åº·ã€æ´»åŠ›çš„ç”Ÿæ´»çŠ¶æ€
- å…³é”®ç‰¹å¾ï¼šå¥åº·ã€æ´»åŠ›ã€ç”Ÿæœºã€æ´»è·ƒ
- å…¸å‹è¡¨ç°ï¼šæ´»åŠ›å››å°„ã€å¥åº·çŠ¶æ€ã€ç”Ÿæœºå‹ƒå‹ƒ
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘ä¸»è¦å±•ç¤ºå¥åº·æ´»åŠ›

**æƒ…æ„Ÿè¿æ¥**: å¼ºè°ƒäº²æƒ…ã€æƒ…æ„Ÿçº½å¸¦å’Œè¿æ¥
- å…³é”®ç‰¹å¾ï¼šäº²æƒ…ã€æƒ…æ„Ÿã€è¿æ¥ã€çº½å¸¦
- å…¸å‹è¡¨ç°ï¼šäº²å­äº’åŠ¨ã€æƒ…æ„Ÿè¡¨è¾¾ã€äº²æƒ…è¿æ¥
- å¤šé•œå¤´æƒ…å†µï¼šå¦‚æœè§†é¢‘é‡ç‚¹ä¼ è¾¾æƒ…æ„Ÿè¿æ¥

## ğŸ“ è¾“å‡ºæ ¼å¼è¦æ±‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š

```json
{
    "secondary_category": "å­åˆ†ç±»åç§°",
    "confidence": ç½®ä¿¡åº¦åˆ†æ•°(0.0-1.0),
    "reasoning": "åˆ†ç±»ä¾æ®çš„è¯¦ç»†è¯´æ˜",
    "matched_features": ["åŒ¹é…åˆ°çš„å…³é”®ç‰¹å¾"],
    "multi_scene_analysis": "å¦‚æœæ˜¯å¤šé•œå¤´è§†é¢‘ï¼Œè¯´æ˜é€‰æ‹©æ­¤åˆ†ç±»çš„åŸå› "
}
```

è¯·åˆ†æä»¥ä¸‹Labelså†…å®¹ï¼š"""
        }
    
    def classify_secondary_category(self, main_tag: str, labels_text: str) -> Tuple[str, float, Dict]:
        """
        å¯¹Labelså†…å®¹è¿›è¡ŒäºŒçº§åˆ†ç±»
        
        Args:
            main_tag: ä¸»æ ‡ç­¾ç±»åˆ«
            labels_text: å¾…åˆ†ç±»çš„Labelsæ–‡æœ¬å†…å®¹
            
        Returns:
            Tuple[secondary_category, confidence, analysis_result]
        """
        try:
            logger.info(f"ğŸ¤– å¼€å§‹äºŒçº§åˆ†ç±»: {main_tag}")
            
            if not labels_text or labels_text.strip() == "":
                return "", 0.0, {"reason": "æ— æ ‡ç­¾å†…å®¹"}
            
            if main_tag not in self.main_categories:
                return "", 0.0, {"reason": f"ä¸æ”¯æŒçš„ä¸»æ ‡ç­¾: {main_tag}"}
            
            # æ„å»ºæç¤ºè¯
            prompts = self._build_classification_prompts()
            prompt = prompts.get(main_tag, "")
            full_prompt = f"{prompt}\n\nLabelså†…å®¹:\n{labels_text}"
            
            # ä½¿ç”¨åŸºç±»çš„åˆ†ç±»æ–¹æ³•
            result = self.classify(full_prompt)
            
            if not result or "error" in result:
                logger.error("äºŒçº§åˆ†ç±»å¤±è´¥")
                return "", 0.0, result or {"error": "åˆ†ç±»å¤±è´¥"}
            
            # è§£æç»“æœ
            secondary_category = result.get("secondary_category", "")
            confidence = float(result.get("confidence", 0.0))
            
            # éªŒè¯åˆ†ç±»ç»“æœæ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
            valid_categories = self.main_categories.get(main_tag, [])
            if secondary_category not in valid_categories and secondary_category != "":
                logger.warning(f"æ— æ•ˆçš„äºŒçº§åˆ†ç±»: {secondary_category}")
                secondary_category = ""
                confidence = 0.0
            
            logger.info(f"âœ… äºŒçº§åˆ†ç±»å®Œæˆ: {secondary_category} (ç½®ä¿¡åº¦: {confidence:.2f})")
            
            return secondary_category, confidence, result
            
        except Exception as e:
            logger.error(f"äºŒçº§åˆ†ç±»å¼‚å¸¸: {e}")
            return "", 0.0, {"error": str(e)}

    def batch_classify_secondary(self, slice_data_list: List[Dict], main_tag: str, 
                               min_confidence: float = 0.5) -> List[Dict]:
        """
        æ‰¹é‡è¿›è¡ŒäºŒçº§AIåˆ†ç±»
        
        Args:
            slice_data_list: åˆ‡ç‰‡æ•°æ®åˆ—è¡¨
            main_tag: ä¸»æ ‡ç­¾
            min_confidence: æœ€å°ç½®ä¿¡åº¦é˜ˆå€¼
            
        Returns:
            åŒ…å«äºŒçº§åˆ†ç±»ç»“æœçš„åˆ‡ç‰‡æ•°æ®åˆ—è¡¨
        """
        try:
            logger.info(f"ğŸ¤– å¼€å§‹äºŒçº§AIæ‰¹é‡åˆ†ç±»: {main_tag} ({len(slice_data_list)} ä¸ªåˆ‡ç‰‡)")
            
            # ğŸ”§ ä¿®å¤ï¼šç›´æ¥è°ƒç”¨classify_secondary_categoryï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„main_tag
            results = []
            for i, item in enumerate(slice_data_list):
                labels_text = item.get("labels", "")
                slice_name = item.get("slice_name", f"slice_{i}")
                
                # è°ƒç”¨å•é¡¹äºŒçº§åˆ†ç±»æ–¹æ³•ï¼ˆä¼ é€’æ­£ç¡®çš„main_tagï¼‰
                secondary_category, confidence, analysis = self.classify_secondary_category(main_tag, labels_text)
                
                # æ„å»ºç»“æœæ ¼å¼
                result = {
                    "id": slice_name,
                    "category": secondary_category,
                    "confidence": confidence,
                    "reasoning": analysis.get("reasoning", ""),
                    "matched_features": analysis.get("matched_features", []),
                    "success": confidence >= min_confidence
                }
                results.append(result)
            
            # ğŸ“Š ç»Ÿè®¡äºŒçº§åˆ†ç±»ç»“æœ
            category_stats = {}
            successful_count = 0
            
            # åˆå¹¶ç»“æœå¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
            enriched_results = []
            for i, slice_data in enumerate(slice_data_list):
                enriched_slice = slice_data.copy()
                slice_name = slice_data.get("slice_name", f"slice_{i}")
                
                if i < len(results):
                    result = results[i]
                    secondary_category = result.get("category", "")
                    confidence = result.get("confidence", 0.0)
                    
                    # æ›´æ–°åˆ‡ç‰‡æ•°æ®
                    enriched_slice.update({
                        "secondary_category": secondary_category,
                        "secondary_confidence": confidence,
                        "secondary_reasoning": result.get("reasoning", ""),
                        "secondary_features": result.get("matched_features", [])
                    })
                    
                    # ğŸ“‹ æ˜¾ç¤ºæ¯ä¸ªåˆ‡ç‰‡çš„åˆ†ç±»ç»“æœ
                    if secondary_category and confidence >= min_confidence:
                        logger.info(f"  âœ… {slice_name}: {secondary_category} (ç½®ä¿¡åº¦: {confidence:.2f})")
                        successful_count += 1
                        
                        # ç»Ÿè®¡ç±»åˆ«åˆ†å¸ƒ
                        if secondary_category in category_stats:
                            category_stats[secondary_category] += 1
                        else:
                            category_stats[secondary_category] = 1
                    else:
                        logger.warning(f"  âŒ {slice_name}: åˆ†ç±»å¤±è´¥ (ç½®ä¿¡åº¦: {confidence:.2f})")
                else:
                    logger.error(f"  ğŸ’¥ {slice_name}: å¤„ç†å¼‚å¸¸")
                
                enriched_results.append(enriched_slice)
            
            # ğŸ“Š è¾“å‡ºåˆ†ç±»ç»Ÿè®¡æ±‡æ€»
            logger.info(f"ğŸ“Š {main_tag} äºŒçº§åˆ†ç±»å®Œæˆç»Ÿè®¡:")
            logger.info(f"  ğŸ“ˆ æˆåŠŸåˆ†ç±»: {successful_count}/{len(slice_data_list)} ä¸ªåˆ‡ç‰‡")
            
            if category_stats:
                logger.info(f"  ğŸ·ï¸ å­ç±»åˆ«åˆ†å¸ƒ:")
                for category, count in sorted(category_stats.items(), key=lambda x: x[1], reverse=True):
                    percentage = (count / successful_count) * 100 if successful_count > 0 else 0
                    logger.info(f"    â€¢ {category}: {count} ä¸ª ({percentage:.1f}%)")
            else:
                logger.warning(f"  âš ï¸ æœªå‘ç°æœ‰æ•ˆçš„å­ç±»åˆ«åˆ†ç±»")
            
            return enriched_results
            
        except Exception as e:
            logger.error(f"æ‰¹é‡äºŒçº§åˆ†ç±»å¼‚å¸¸: {e}")
            return slice_data_list




if __name__ == "__main__":
    pass 
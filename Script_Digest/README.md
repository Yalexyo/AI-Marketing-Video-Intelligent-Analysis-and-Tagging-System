# Script Digest - 视频脚本智能匹配系统

一个基于AI的智能系统，能够将用户输入的脚本段落与大量视频切片进行语义匹配，并自动将匹配的视频组织到对应的文件夹中。

## 🎯 核心功能

- **智能脚本解析**：动态分析用户输入的脚本段落
- **AI语义匹配**：使用DeepSeek API进行视频内容与脚本的语义匹配
- **自动文件组织**：将匹配的视频自动复制到以脚本段落命名的文件夹中
- **灵活的ID系统**：支持emoji、中文、英文等各种格式的段落ID

## 🚀 快速开始

### 1. 启动程序
```bash
# 方法1：使用启动脚本
./start.sh

# 方法2：直接运行Python
python3 run.py
```

### 2. 选择脚本输入方式
程序启动后，您可以选择使用默认脚本或自定义输入：

```
📝 脚本输入选择：
1. 使用默认脚本（推荐）
2. 自定义输入脚本

🎯 默认脚本预览：
   1️⃣: 狗都不，生！生的就是纯奶粉喂养八斤八两...
   2️⃣: 能自己喂肯定是更好的，但凡你决定了奶粉喂养...
   3️⃣: 怕你走弯路，我必须再多嘴两句，配方你肯定...
   4️⃣: 毕竟是宝宝进嘴的东西，启赋背靠惠氏制药...
   5️⃣: 你就问问身边吃奶启赋的妈妈们吧，个个养...
   6️⃣: 选奶关键的就是不试错，你不冲我可要冲了！

请选择 (1-默认脚本 / 2-自定义输入): 1
✅ 使用默认脚本
```

#### 如果选择自定义输入：
```
📝 自定义脚本输入
💡 格式说明：
   - 每行一个段落
   - 格式：段落ID:段落内容
   - 示例：1️⃣:狗都不，生！
   - 输入空行结束输入

开始输入：
 1> 1️⃣:狗都不，生！
 2> 2️⃣:能自己喂肯定是更好的
 3> (空行结束输入)
```

### 3. 选择视频切片目录
程序会提示您选择包含JSON分析文件的视频切片目录。

### 4. 查看结果
匹配完成后，系统会自动创建以脚本段落命名的文件夹，如：
- 【1狗都不，生...】
- 【2能自己喂肯...】
- 【3怕你走错了...】

## 📝 用户输入详解

### segment_id（段落ID）的来源
**segment_id 完全由用户输入决定**，系统不会自动生成或修改。

#### 支持的ID格式：
- **Emoji数字**：`1️⃣`, `2️⃣`, `3️⃣`
- **普通数字**：`1`, `2`, `3`
- **描述性**：`S01_Brand`, `Hook_Opening`
- **中文**：`段落1`, `品牌介绍`

#### 文件夹命名规则：
系统会根据您输入的segment_id自动生成文件夹名：
```
文件夹名 = 【{从ID提取的数字}{内容前5字}...】
```

例如：
- `1️⃣` + `"狗都不，生！"` → `【1狗都不，生...】`
- `2️⃣` + `"能自己喂肯定是更好的"` → `【2能自己喂肯...】`
- `S01_Brand` + `"选有百年科研实力的品牌"` → `【1选有百年科...】`

## 🔧 技术架构

### 核心模块
- **环境加载器** (`env_loader.py`) - 智能复用现有API配置
- **动态配置管理器** (`dynamic_match_config.py`) - 灵活的匹配规则
- **DeepSeek AI客户端** (`deepseek_client.py`) - AI语义匹配
- **脚本解析器** (`script_parser.py`) - 动态脚本分析
- **JSON分析器** (`json_analyzer.py`) - 视频切片数据提取
- **视频匹配器** (`video_matcher.py`) - 核心匹配逻辑
- **文件组织器** (`file_organizer.py`) - 智能文件夹命名与组织

### 处理流程
1. **用户输入** → 脚本段落（用户自定义segment_id）
2. **脚本解析** → 提取关键词、分析类型和情绪
3. **视频扫描** → 读取JSON分析文件，提取视频特征
4. **AI匹配** → 使用DeepSeek进行语义匹配打分
5. **文件组织** → 创建文件夹并复制匹配的视频

## ⚙️ 配置要求

### API密钥配置
在 `../slice_to_label/config/env_config.txt` 中配置：
```
DEEPSEEK_API_KEY=your_deepseek_api_key_here
```

### 目录结构
```
Script_Digest/
├── src/                    # 核心模块
├── config/                 # 配置文件
├── data/
│   ├── input/             # 输入数据
│   └── output/            # 输出结果
├── logs/                  # 日志文件
├── run.py                 # 主入口程序
├── start.sh              # 启动脚本
└── README.md             # 说明文档
```

## 📊 示例用法

### 默认脚本内容
系统内置了完整的默认脚本，用户可以直接使用：

```
1️⃣: 狗都不，生！生的就是纯奶粉喂养八斤八两的大胖娃！

2️⃣: 能自己喂肯定是更好的，但凡你决定了奶粉喂养，就一定要选有百年科研实力，专业渠道也认可的品牌。

3️⃣: 怕你走弯路，我必须再多嘴两句，配方你肯定是越看越花眼 越做功课越不会选，其实！你只要关注有没有 HMO，以及 HMO 的科研背景就够了！

4️⃣: 毕竟是宝宝进嘴的东西，启赋背靠惠氏制药背景，做起奶粉降维打击，对 HMO 的研究比我岁数都长！

5️⃣: 你就问问身边吃奶启赋的妈妈们吧，个个养成小肉宝，娃是越来越好带了，妈也越来越美了。

6️⃣: 选奶关键的就是不试错，你不冲我可要冲了！
```

### 输出结果
```
data/output/
├── 【1狗都不，生...】/
│   ├── 【参考】/                             # 保留未被AI选中的其他候选视频
│   │   ├── 母婴互动温馨时刻.mp4              # 预筛选通过但未被AI选为最佳
│   │   └── 喂奶温情画面.mp4                  # 预筛选通过但未被AI选为最佳
│   ├── 0.85_温馨日常_宝宝喝奶瓶中的奶.mp4     # AI选出的最佳匹配（带分数前缀）
│   ├── 0.82_父亲温柔喂养宝宝.mp4             # AI选出的最佳匹配
│   ├── 0.76_奶粉喂养场景.mp4                 # AI选出的最佳匹配
│   └── pass.json                             # AI匹配分析结果
├── 【2能自己喂肯...】/
│   ├── 【参考】/                             # 该段落的其他候选视频
│   │   ├── 科研实力展示.mp4                  # 未被选中的候选
│   │   └── 品牌历史介绍.mp4                  # 未被选中的候选
│   ├── 0.88_品牌展示_惠氏奶粉.mp4             # 最佳匹配
│   ├── 0.81_专业营养师推荐.mp4               # 最佳匹配
│   └── pass.json
└── 【3怕你走错了...】/
    ├── 【参考】/                             # 如果所有预筛选视频都被AI选中，
    │   └── (可能为空或不存在)                  # 则此文件夹为空或被自动删除
    ├── 0.92_HMO科研介绍.mp4
    ├── 0.79_配方奶粉对比.mp4
    ├── 0.75_科学配方解析.mp4
    ├── 0.71_专业研究成果.mp4
    └── pass.json
```

🎯 **智能文件管理逻辑：**
- ✅ **最佳匹配区**：段落根目录显示AI选出的最佳匹配视频（带分数前缀，自动排序）
- ✅ **候选备用区**：【参考】文件夹仅保留未被AI选中的其他候选视频
- ✅ **避免重复**：已选中的视频不会在【参考】文件夹中重复存在
- ✅ **动态清理**：如果所有预筛选视频都被选为最佳匹配，【参考】文件夹自动删除

## 🤝 贡献

欢迎提交Issue和Pull Request来改进这个项目！

## 📄 许可证

本项目采用MIT许可证。 
"""
åˆ‡ç‰‡åˆ†æé…ç½®æ–‡ä»¶
å®šä¹‰æ‰€æœ‰AIæ¨¡å‹å‚æ•°ã€ä¸šåŠ¡åˆ†ç±»è§„åˆ™å’Œè´¨é‡æ§åˆ¶æ ‡å‡†
"""

import os
import logging
from pathlib import Path
from typing import Dict, Any, List

# åŠ è½½ç¯å¢ƒå˜é‡
try:
    from ..src.env_loader import load_environment, EnvLoader
    _env_loader = load_environment()
    get_api_key = lambda x: _env_loader.get_api_keys().get(x.lower(), "")
    get_project_config = lambda: {}
except ImportError:
    print("Warning: env_loader not available, using environment variables directly")
    get_api_key = lambda x: os.getenv(f"{x.upper()}_API_KEY", "")
    get_project_config = lambda: {}

logger = logging.getLogger(__name__)

def get_api_keys() -> Dict[str, str]:
    """è·å–APIå¯†é’¥é…ç½® - æ”¯æŒå¤šä¸ªAIæ¨¡å‹ï¼Œä¼˜å…ˆä»é…ç½®æ–‡ä»¶è¯»å–"""
    
    # å…ˆå°è¯•ä»é…ç½®æ–‡ä»¶è¯»å–
    config_keys = _load_api_keys_from_config()
    
    # ç„¶åä»ç¯å¢ƒå˜é‡è·å–ï¼ˆè¦†ç›–é…ç½®æ–‡ä»¶ï¼‰
    env_keys = {
        "dashscope": os.getenv("DASHSCOPE_API_KEY", ""),
        "deepseek": os.getenv("DEEPSEEK_API_KEY", ""), 
        "qwen": os.getenv("DASHSCOPE_API_KEY", ""),  # Qwenä½¿ç”¨DashScope API
        "gemini": os.getenv("GOOGLE_AI_API_KEY", ""),  # Google Gemini APIå¯†é’¥
        "openrouter": os.getenv("OPENROUTER_API_KEY", ""),  # OpenRouter APIå¯†é’¥ï¼ˆç”¨äºGemini 2.5 Proï¼‰
        "google_cloud": os.getenv("GOOGLE_APPLICATION_CREDENTIALS", "")  # Google Cloudå‡­æ®
    }
    
    # åˆå¹¶é…ç½®ï¼šç¯å¢ƒå˜é‡ä¼˜å…ˆï¼Œé…ç½®æ–‡ä»¶å¤‡ç”¨
    final_keys = {}
    for key in ["dashscope", "deepseek", "qwen", "gemini", "openrouter", "google_cloud"]:
        final_keys[key] = env_keys.get(key) or config_keys.get(key, "")
    
    return final_keys

def _load_api_keys_from_config() -> Dict[str, str]:
    """ä»é…ç½®æ–‡ä»¶åŠ è½½APIå¯†é’¥"""
    try:
        config_path = Path(__file__).parent / "env_config.txt"
        config_keys = {}
        
        if config_path.exists():
            with open(config_path, 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#') and '=' in line:
                        key, value = line.split('=', 1)
                        key = key.strip()
                        value = value.strip()
                        
                        # è·³è¿‡å ä½ç¬¦å€¼
                        if value and value not in ["your_google_ai_api_key_here", "your_openrouter_api_key_here"]:
                            if key == "DASHSCOPE_API_KEY":
                                config_keys["dashscope"] = value
                                config_keys["qwen"] = value  # Qwenä½¿ç”¨DashScope
                            elif key == "DEEPSEEK_API_KEY":
                                config_keys["deepseek"] = value
                            elif key == "GOOGLE_AI_API_KEY":
                                config_keys["gemini"] = value
                            elif key == "OPENROUTER_API_KEY":
                                config_keys["openrouter"] = value
                            elif key == "GOOGLE_APPLICATION_CREDENTIALS":
                                config_keys["google_cloud"] = value
                                
        logger.info(f"âœ… ä»é…ç½®æ–‡ä»¶åŠ è½½äº† {len(config_keys)} ä¸ªAPIå¯†é’¥")
        return config_keys
        
    except Exception as e:
        logger.warning(f"âš ï¸ é…ç½®æ–‡ä»¶è¯»å–å¤±è´¥: {e}")
        return {}

def get_default_model_selection() -> Dict[str, Any]:
    """è·å–é»˜è®¤æ¨¡å‹é€‰æ‹©é…ç½® - ä¿®æ­£ä¸ºQwenä¼˜å…ˆ"""
    return {
        "primary_visual_model": "qwen",    # âœ… ä¿®æ­£ï¼šé»˜è®¤ä½¿ç”¨Qwen VL Max
        "use_gemini_upgrade": False,       # âœ… ä¿®æ­£ï¼šå…³é—­Geminiä¼˜å…ˆæ¨¡å¼
        "upgrade_reason": "éµå¾ªè®¾è®¡åŸåˆ™ï¼šä½æˆæœ¬ä¸»æ¨¡å‹+é«˜ç²¾åº¦å‡çº§æ¨¡å‹",
        "fallback_model": "gemini",        # âœ… ä¿®æ­£ï¼šGeminiä½œä¸ºå‡çº§æ¨¡å‹
        "auto_upgrade_enabled": True       # å¯ç”¨è‡ªåŠ¨å‡çº§æœºåˆ¶
    }

def get_models_config() -> Dict[str, Dict[str, Any]]:
    """è·å–AIæ¨¡å‹é…ç½® - æ”¯æŒå¤šæ¨¡å‹åˆ‡æ¢ï¼ŒåŒ…æ‹¬Google Gemini 2.5 Pro"""
    return {
        "qwen": {
            "model_name": "qwen-vl-max-latest",
            "frame_rate": 2.0,
            "max_retries": 5,      # ğŸ”„ ä»3å¢åŠ åˆ°5æ¬¡é‡è¯•
            "timeout": 90,         # â±ï¸ ä»30å¢åŠ åˆ°90ç§’è¶…æ—¶
            "retry_delay": 2,      # ğŸ†• æ–°å¢ï¼šé‡è¯•é—´éš”æ—¶é—´
            "dual_model_workflow": True,  # å¯ç”¨åŒæ¨¡å‹åˆ†å·¥æœºåˆ¶
            "stage1_general": True,       # ç¬¬ä¸€é˜¶æ®µï¼šé€šç”¨è¯†åˆ«
            "stage2_brand_trigger": True  # ç¬¬äºŒé˜¶æ®µï¼šæ¡ä»¶è§¦å‘å“ç‰Œæ£€æµ‹
        },
        "gemini": {
            "model_name": "gemini-2.5-pro",  # æœ€æ–°çš„Gemini 2.5 Pro
            "openrouter_model": "google/gemini-2.5-pro",  # é€šè¿‡OpenRouterè°ƒç”¨çš„æ¨¡å‹å
            "frame_rate": 1.5,
            "max_retries": 3,
            "timeout": 60,  # å¢åŠ è¶…æ—¶æ—¶é—´ä»¥é€‚åº”OpenRouter
            "dual_model_workflow": True,  
            "stage1_general": True,      
            "stage2_brand_trigger": True,
            "enhanced_reasoning": True,   # Geminiçš„å¢å¼ºæ¨ç†èƒ½åŠ›
            "multimodal_focus": True,    # ä¸“æ³¨å¤šæ¨¡æ€åˆ†æ
            "use_openrouter": True,      # ä¼˜å…ˆä½¿ç”¨OpenRouter API
            "fallback_to_google": True,   # å¤±è´¥æ—¶å›é€€åˆ°Google API
            "enhanced_frame_extraction": True,  # ğŸš€ å¯ç”¨å¢å¼ºå¸§æå–ï¼ˆæ›´å¤šå¸§ï¼‰
            "use_smart_extractor": False,  # ğŸ¯ å¯é€‰ï¼šä½¿ç”¨æ™ºèƒ½å¸§æå–å™¨ï¼ˆå†…å®¹å˜åŒ–æ£€æµ‹ï¼‰
            "max_frames": 8  # ï¿½ï¿½ æœ€å¤§å¸§æ•°é™åˆ¶
        },
        "deepseek": {
            "model_name": "deepseek-chat", 
            "max_tokens": 2048,
            "temperature": 0.1,
            "max_retries": 3,
            "timeout": 30,
            "role": "audio_analysis"  # ä¸“æ³¨è¯­éŸ³åˆ†æ
        },
        "dashscope": {
            "model_name": "paraformer-realtime-v2",
            "language": "zh",
            "enable_words": True,
            "max_retries": 3,
            "timeout": 60,
            "role": "transcription"  # ä¸“æ³¨è¯­éŸ³è½¬å½•
        }
    }

def get_core_brands() -> List[str]:
    """è·å–æ ¸å¿ƒå“ç‰Œåˆ—è¡¨ - ä¸¥æ ¼æŒ‰ä¸»ç¨‹åºé…ç½®"""
    return [
        'å¯èµ‹', 'illuma', 'æƒ æ°', 'Wyeth', 'è•´æ·³', 
        'A2', 'ATWO', 'HMO'
    ]

def get_brand_trigger_keywords() -> List[str]:
    """è·å–è§¦å‘å“ç‰Œæ£€æµ‹çš„å…³é”®è¯ - åŸºäºä¸»ç¨‹åºé…ç½®"""
    return [
        # è¡Œä¸º/äº’åŠ¨ç›¸å…³ï¼ˆä¸»è°“å®¾ç»“æ„ä¸­çš„å…³é”®åŠ¨è¯å’Œå®¾è¯­ï¼‰
        'ç½', 'äº§å“', 'å–‚å…»', 'å–', 'å†²æ³¡', 'æ…æ‹Œ',
        # ä¼ ç»Ÿç‰©ä½“ç›¸å…³
        'å¥¶ç²‰ç½', 'å¥¶ç“¶', 'å¥¶ç²‰', 'é…æ–¹å¥¶', 'å©´å„¿å¥¶ç²‰',
        'å¥¶ç²‰åŒ…è£…', 'å¥¶ç²‰ç½ç‰¹å†™', 'æˆåˆ†è¡¨', 'é…æ–™è¡¨',
        'è¥å…»æˆåˆ†', 'äº§å“åŒ…è£…', 'åŒ…è£…ç›’'
    ]

def get_visual_objects() -> List[str]:
    """è·å–è§†è§‰è¯†åˆ«å¯¹è±¡åˆ—è¡¨ - å‚è€ƒä¸»ç¨‹åºé…ç½®"""
    return [
        "å®å®", "å©´å„¿", "å¦ˆå¦ˆ", "çˆ¸çˆ¸", "åŒ»ç”Ÿ", "æŠ¤å£«",
        "å¥¶ç“¶", "å¥¶å˜´", "é¤å…·", "ç©å…·", "è¡£æœ", "åºŠé“º",
        "åŒ»ç–—è®¾å¤‡", "ä½“é‡ç§¤", "æ¸©åº¦è®¡", "æ‘‡ç¯®", "æ¨è½¦"
    ]

def get_scenes() -> List[str]:
    """è·å–åœºæ™¯åˆ—è¡¨ - å‚è€ƒä¸»ç¨‹åºé…ç½®"""
    return [
        "å®¤å†…", "å®¶ä¸­å§å®¤", "å®¢å…", "å¨æˆ¿", "å©´å„¿æˆ¿",
        "åŒ»é™¢", "è¯Šæ‰€", "æˆ·å¤–", "å…¬å›­", "å•†åº—", "è¶…å¸‚"
    ]

def get_emotions() -> List[str]:
    """è·å–æƒ…ç»ªåˆ—è¡¨ - å‚è€ƒä¸»ç¨‹åºé…ç½®"""
    return [
        "å¼€å¿ƒ", "æ¸©é¦¨", "å¹³é™", "ç„¦è™‘", "æ‹…å¿ƒ", "æ»¡æ„"
    ]

def get_quality_control() -> Dict[str, Any]:
    """è·å–è´¨é‡æ§åˆ¶å‚æ•°"""
    return {
        "min_file_size_mb": 0.1,
        "max_file_size_mb": 500,
        "min_duration_seconds": 1,
        "max_duration_seconds": 600,
        "supported_formats": [".mp4", ".avi", ".mov", ".mkv", ".m4v", ".MP4", ".MOV"],
        "min_confidence": 0.3,
        "quality_threshold": 0.5
    }

def get_analysis_prompts() -> Dict[str, str]:
    """è·å–AIåˆ†ææç¤ºè¯æ¨¡æ¿ - ä¸¥æ ¼æŒ‰ä¸»ç¨‹åºåŒå±‚æœºåˆ¶"""
    
    # åŸºç¡€æ•°æ®ä»é…ç½®è·å–
    visual_objects = get_visual_objects()[:15]  # å–å‰15ä¸ªå¸¸è§ç‰©ä½“
    scenes = get_scenes()[:10]  # å–å‰10ä¸ªå¸¸è§åœºæ™¯
    emotions = get_emotions()[:6]  # å–å‰6ä¸ªæƒ…ç»ª
    core_brands = get_core_brands()
    
    return {
        # ğŸ¯ ç¬¬ä¸€é˜¶æ®µï¼šAI-Bé€šç”¨æ£€æµ‹promptï¼ˆå¼ºè°ƒä¸»è°“å®¾äº¤äº’è¯†åˆ«ï¼‰
        "stage1_general_detection": f"""ğŸ¯ ä½ æ˜¯ä¸“ä¸šçš„è§†é¢‘å†…å®¹åˆ†æå¸ˆï¼Œè¯·ä»”ç»†åˆ†æç”»é¢å†…å®¹å¹¶æè¿°ä¸ºå…·ä½“çš„"è¡Œä¸º/äº¤äº’"çŸ­å¥ã€‚

**ğŸ¯ åˆ†æåŸåˆ™**ï¼š
- ä»”ç»†è¯†åˆ«ç”»é¢ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼šäººç‰©ã€ç‰©ä½“ã€ç¯å¢ƒã€åŠ¨ä½œç­‰
- æ— è®ºæ˜¯å¦æœ‰äººç‰©å‡ºç°ï¼Œéƒ½è¦è¯¦ç»†æè¿°ç”»é¢å†…å®¹
- å¦‚æœæœ‰äººç‰©ï¼Œé‡ç‚¹æè¿°äººç‰©çš„è¡Œä¸ºå’Œäº¤äº’
- å¦‚æœæ²¡æœ‰äººç‰©ï¼Œé‡ç‚¹æè¿°ç‰©ä½“ã€äº§å“ã€ç¯å¢ƒçš„ç‰¹å¾å’ŒçŠ¶æ€

**é‡è¦ï¼šæœ¬æ¬¡åˆ†æä¸æ¶‰åŠä»»ä½•å“ç‰Œè¯†åˆ«ï¼Œè¯·ä¸“æ³¨äºä»¥ä¸‹ä¸‰ä¸ªç»´åº¦ï¼š**

1. **interactionï¼ˆè¡Œä¸º/äº¤äº’ï¼‰**: **æ ¸å¿ƒä»»åŠ¡**ï¼Œç”¨"ä¸»è¯­+åŠ¨è¯+å®¾è¯­"çš„æ ¼å¼æè¿°ç”»é¢ä¸­çš„æ ¸å¿ƒäº‹ä»¶æˆ–ç‰©ä½“çŠ¶æ€ã€‚
   - **æœ‰äººç‰©æ—¶çš„ç¤ºä¾‹**: "å®å®å¼€å¿ƒå–å¥¶", "å¦ˆå¦ˆå†²æ³¡å¥¶ç²‰", "å®å®æ‹’ç»å¥¶ç“¶", "åŒ»ç”Ÿæ¨èäº§å“"
   - **æ— äººç‰©æ—¶çš„ç¤ºä¾‹**: "å¥¶ç²‰ç½å±•ç¤ºè¥å…»æ ‡ç­¾", "äº§å“åŒ…è£…çªå‡ºå“ç‰Œæ ‡è¯†", "å¥¶ç“¶æ”¾ç½®æ¡Œé¢", "é£Ÿæé™æ€æ‘†æ”¾"
   - **é¿å…**: "å®å®, å¥¶ç“¶" (è¿‡äºå­¤ç«‹)

2. **sceneï¼ˆåœºæ™¯è¯†åˆ«ï¼‰**: å®¢è§‚æè¿°ç”»é¢å‘ç”Ÿçš„åœºæ™¯ç¯å¢ƒ
   - å‚è€ƒè¯æ±‡ï¼š{', '.join(scenes)}

3. **emotionï¼ˆæƒ…ç»ªè¯†åˆ«ï¼‰**: åˆ†æç”»é¢ä¼ è¾¾çš„æ•´ä½“æƒ…ç»ªæˆ–æ°›å›´
   - æœ‰äººç‰©æ—¶ï¼šé‡ç‚¹åˆ†æäººç‰©æƒ…ç»ª
   - æ— äººç‰©æ—¶ï¼šåˆ†æç”»é¢è¥é€ çš„æ°›å›´ï¼ˆå¦‚ï¼šæ¸©é¦¨ã€ä¸“ä¸šã€æ¸…æ–°ç­‰ï¼‰
   - å‚è€ƒè¯æ±‡ï¼š{', '.join(emotions)}

**è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼éµå¾ªï¼‰ï¼š**
interaction: è¡Œä¸º/äº¤äº’çŸ­å¥æˆ–ç‰©ä½“çŠ¶æ€æè¿°
scene: åœºæ™¯æè¿°(å¯å«é€—å·)
emotion: å•ä¸ªå…³é”®è¯""",

        # ğŸ¯ Geminiä¸“ç”¨ï¼šä¸€ä½“åŒ–è§†è§‰è¯†åˆ«promptï¼ˆåŸºç¡€å…ƒç´  + å“ç‰Œè¯†åˆ«ï¼‰
        "stage1_general_detection_gemini": f"""ğŸ¯ ä½ æ˜¯ä¸“ä¸šçš„æ¯å©´è§†é¢‘å†…å®¹åˆ†æå¸ˆï¼Œè¯·å¯¹è§†é¢‘ç”»é¢è¿›è¡Œå…¨é¢çš„è§†è§‰è¯†åˆ«ï¼ŒåŒ…æ‹¬åŸºç¡€å…ƒç´ å’Œå“ç‰Œè¯†åˆ«ã€‚

**ğŸ¯ å…¨é¢åˆ†æç­–ç•¥**ï¼š
- ä»”ç»†è§‚å¯Ÿç”»é¢ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼šäººç‰©ã€ç‰©ä½“ã€äº§å“ã€ç¯å¢ƒã€æ–‡å­—ç­‰
- æ— è®ºæ˜¯å¦æœ‰äººç‰©å‡ºç°ï¼Œéƒ½è¦è¯¦ç»†åˆ†æç”»é¢å†…å®¹çš„ä»·å€¼
- æœ‰äººç‰©æ—¶ï¼šé‡ç‚¹åˆ†æäººç‰©è¡Œä¸ºã€äº¤äº’ã€æƒ…ç»ª
- æ— äººç‰©æ—¶ï¼šé‡ç‚¹åˆ†æäº§å“ç‰¹å¾ã€å“ç‰Œå…ƒç´ ã€ç¯å¢ƒä¿¡æ¯ã€è¥å…»æ ‡ç­¾ç­‰æœ‰ä»·å€¼å†…å®¹

**ğŸ“‹ æ ¸å¿ƒä»»åŠ¡1ï¼šäº¤äº’è¡Œä¸ºç²¾ç¡®è¯†åˆ«**

1. **interactionï¼ˆè¡Œä¸º/äº¤äº’ï¼‰**: **æœ€é«˜ä¼˜å…ˆçº§** - å¿…é¡»ä¸¥æ ¼æŒ‰ç…§"ä¸»è¯­+åŠ¨è¯+å®¾è¯­"æ ¼å¼
   
   **ä¸»è¯­è¯†åˆ«è§„åˆ™ï¼š**
   - æœ‰äººç‰©æ—¶ï¼šå®å®ã€å¦ˆå¦ˆã€çˆ¸çˆ¸ã€åŒ»ç”Ÿã€ä¸“å®¶ã€æŠ¤å£«
   - æ— äººç‰©æ—¶ï¼šäº§å“ã€å¥¶ç²‰ç½ã€å¥¶ç“¶ã€åŒ…è£…ã€æ ‡ç­¾ã€è¥å…»è¡¨
   - é‡ç‚¹ï¼šè¯†åˆ«ç”»é¢ä¸»è¦å…ƒç´ 
   
   **åŠ¨è¯è¯†åˆ«è§„åˆ™ï¼š**
   - äººç‰©åŠ¨ä½œï¼šå–ã€æ‹’ç»ã€å†²æ³¡ã€å±•ç¤ºã€æ¨èã€å“­é—¹ã€æ‹¥æŠ±ã€è§‚å¯Ÿã€æ£€æŸ¥
   - ç‰©ä½“çŠ¶æ€ï¼šå±•ç¤ºã€çªå‡ºã€æ‘†æ”¾ã€å‘ˆç°ã€æ ‡æ˜ã€æ˜¾ç¤º
   - é¿å…æ¨¡ç³Šè¯ï¼šåœ¨ã€æœ‰ã€å‡ºç°
   
   **å®¾è¯­è¯†åˆ«è§„åˆ™ï¼š**
   - ç‰©å“ï¼šå¥¶ç“¶ã€å¥¶ç²‰ã€äº§å“ã€ç©å…·ã€è¥å…»æˆåˆ†ã€æ ‡ç­¾
   - çŠ¶æ€ï¼šå®‰å…¨æ„Ÿã€è¥å…»ã€æ¸©åº¦ã€ä¿¡æ¯ã€å“è´¨
   
   **âœ… ä¼˜ç§€ç¤ºä¾‹:**
   - æœ‰äººç‰©ï¼š"å®å®ä¸»åŠ¨å–å¥¶", "å¦ˆå¦ˆä»”ç»†å†²æ³¡å¥¶ç²‰", "åŒ»ç”Ÿè€å¿ƒè§£ç­”é—®é¢˜", "å®å®æŠ—æ‹’æ–°å¥¶ç²‰"
   - æ— äººç‰©ï¼š"å¥¶ç²‰ç½å±•ç¤ºè¥å…»æ ‡ç­¾", "äº§å“åŒ…è£…çªå‡ºå“ç‰Œæ ‡è¯†", "è¥å…»è¡¨æ˜¾ç¤ºDHAå«é‡", "å¥¶ç“¶æ‘†æ”¾æ•´é½"

2. **sceneï¼ˆåœºæ™¯ç¯å¢ƒï¼‰**: ç²¾ç¡®çš„ç©ºé—´å®šä½
   - å®¤å†…ç©ºé—´ï¼š{', '.join([s for s in scenes if 'å®¤å†…' in s or 'å®¶ä¸­' in s])}
   - ä¸“ä¸šåœºæ‰€ï¼š{', '.join([s for s in scenes if 'åŒ»é™¢' in s or 'è¯Šæ‰€' in s])}

3. **emotionï¼ˆæ ¸å¿ƒæƒ…ç»ªï¼‰**: ä»è¡Œä¸ºæ¨æ–­çœŸå®æƒ…ç»ªçŠ¶æ€
   - æ­£é¢ï¼š{', '.join([e for e in emotions if e in ['å¼€å¿ƒ', 'æ¸©é¦¨', 'æ»¡æ„']])}
   - ä¸­æ€§ï¼š{', '.join([e for e in emotions if e in ['å¹³é™', 'ä¸“æ³¨']])}
   - è´Ÿé¢ï¼š{', '.join([e for e in emotions if e in ['ç„¦è™‘', 'æ‹…å¿ƒ']])}

**ğŸ·ï¸ æ ¸å¿ƒä»»åŠ¡2ï¼šå“ç‰Œè¯†åˆ«**

4. **brand_elementsï¼ˆå“ç‰Œè¯†åˆ«ï¼‰**: ä¸¥æ ¼æŒ‰ç…§æ ¸å¿ƒå“ç‰Œåˆ—è¡¨è¯†åˆ«ç”»é¢ä¸­çš„å“ç‰Œå…ƒç´ 
   
   **æ ¸å¿ƒå“ç‰Œåˆ—è¡¨ï¼š**
   `{', '.join(core_brands)}`
   
   **è¯†åˆ«é‡ç‚¹ï¼š**
   - å¥¶ç²‰ç½åŒ…è£…ä¸Šçš„å“ç‰ŒLogoæˆ–æ–‡å­—
   - äº§å“åŒ…è£…æ­£é¢çš„å“ç‰Œåç§°
   - ä»»ä½•ä¸æ ¸å¿ƒå“ç‰Œåˆ—è¡¨ç›¸å…³çš„æ¸…æ™°å¯è§æ ‡è¯†
   - **ATWOå­—æ ·**ï¼šA2å¥¶æºã€A2è›‹ç™½è´¨ç­‰ç›¸å…³æ ‡è¯†
   - **æˆåˆ†è¡¨ä¿¡æ¯**ï¼šè¥å…»æˆåˆ†è¡¨ã€é…æ–™è¡¨ã€DHAã€HMOç­‰å…³é”®æˆåˆ†æ ‡è¯†
   
   **ä¸¥æ ¼è¦æ±‚ï¼š**
   - åªè¯†åˆ«åˆ—è¡¨ä¸­çš„å“ç‰Œï¼Œå…¶ä»–å“ç‰Œä¸€å¾‹å¿½ç•¥
   - ATWOå­—æ ·å¿…é¡»æ¸…æ™°å¯è§ï¼Œæ¨¡ç³Šæˆ–è§’åº¦ä¸ä½³æ—¶ä¸è¯†åˆ«
   - æˆåˆ†è¡¨å¿…é¡»æ˜¯æ­£å¼çš„è¥å…»æ ‡ç­¾æˆ–é…æ–™è¡¨ï¼Œé›¶æ•£æˆåˆ†è¯æ±‡ä¸ç®—
   - ç”»é¢æ¨¡ç³Šã€è§’åº¦ä¸ä½³æˆ–æ— æ³•100%ç¡®è®¤æ—¶ï¼Œè¾“å‡º"æ— "
   - æœªæ£€æµ‹åˆ°ä»»ä½•æ ¸å¿ƒå“ç‰Œã€ATWOæˆ–æˆåˆ†è¡¨æ—¶ï¼Œè¾“å‡º"æ— "
   
   **è¾“å‡ºæ ¼å¼ï¼š**
   - æ£€æµ‹åˆ°å“ç‰Œï¼šç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚"å¯èµ‹, illuma"
   - æ£€æµ‹åˆ°ATWOï¼šè¾“å‡º"A2å¥¶æº"æˆ–"A2è›‹ç™½è´¨"
   - æ£€æµ‹åˆ°æˆåˆ†è¡¨ï¼šè¾“å‡º"è¥å…»æˆåˆ†è¡¨"æˆ–å…·ä½“æˆåˆ†å¦‚"DHA, HMO"
   - å¤šé¡¹æ£€æµ‹ï¼šç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚"å¯èµ‹, A2å¥¶æº, DHA"
   - æœªæ£€æµ‹åˆ°ï¼šè¾“å‡º"æ— "

**ğŸ¯ Geminiå¢å¼ºæŒ‡å¯¼ï¼š**
- åˆ©ç”¨å¤šæ¨¡æ€èƒ½åŠ›åŒæ—¶åˆ†æè§†è§‰å’Œç©ºé—´å…³ç³»
- æ³¨é‡æ—¶åºæ€§ï¼šåŠ¨ä½œçš„å‰å› åæœ
- è¯†åˆ«å¾®è¡¨æƒ…ï¼šç»†å¾®çš„æƒ…ç»ªå˜åŒ–
- å…³æ³¨äº¤äº’å¯¹è±¡ï¼šäººä¸äººã€äººä¸ç‰©çš„å…³ç³»
- ç²¾ç¡®å“ç‰Œè¯†åˆ«ï¼šä»”ç»†æ£€æŸ¥åŒ…è£…ã€Logoã€æ–‡å­—

**è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼éµå¾ªï¼‰ï¼š**
interaction: [ä¸»è¯­+åŠ¨è¯+å®¾è¯­çš„å®Œæ•´å¥å­]
scene: [ç²¾ç¡®çš„åœºæ™¯æè¿°]
emotion: [å•ä¸ªæœ€æ ¸å¿ƒçš„æƒ…ç»ªè¯]
brand_elements: [å“ç‰Œåç§°æˆ–"æ— "]""",

        # ğŸ” ç¬¬äºŒé˜¶æ®µï¼šAI-Aå“ç‰Œä¸“ç”¨æ£€æµ‹prompt
        "stage2_brand_detection": f"""ğŸ” ä½ æ˜¯å“ç‰Œè¯†åˆ«ä¸“å®¶ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§æä¾›çš„å“ç‰Œåˆ—è¡¨æ£€æŸ¥ç”»é¢ã€‚

# **æ ¸å¿ƒä»»åŠ¡**
ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯è¯†åˆ«ç”»é¢ä¸­æ˜¯å¦æ¸…æ™°å‡ºç°äº†ä»¥ä¸‹ **æ ¸å¿ƒå“ç‰Œåˆ—è¡¨** ä¸­çš„ä»»ä½•ä¸€ä¸ªå“ç‰Œæ ‡è¯†ã€‚

# **æ ¸å¿ƒå“ç‰Œåˆ—è¡¨**
`{', '.join(core_brands)}`

# **æ£€æŸ¥é‡ç‚¹**
1. å¥¶ç²‰ç½åŒ…è£…ä¸Šçš„å“ç‰ŒLogoæˆ–æ–‡å­—ã€‚
2. äº§å“åŒ…è£…æ­£é¢çš„å“ç‰Œåç§°ã€‚
3. ä»»ä½•ä¸æ ¸å¿ƒå“ç‰Œåˆ—è¡¨ç›¸å…³çš„æ¸…æ™°å¯è§çš„æ ‡è¯†ã€‚

# **ä¸¥æ ¼è¦æ±‚**
- **åªè¯†åˆ«åˆ—è¡¨ä¸­çš„å“ç‰Œ**ã€‚å¦‚æœç”»é¢ä¸­å‡ºç°äº†å…¶ä»–å“ç‰Œï¼Œå¿½ç•¥å®ƒä»¬ã€‚
- å¦‚æœç”»é¢æ¨¡ç³Šã€è§’åº¦ä¸ä½³æˆ–æ— æ³•100%ç¡®è®¤ï¼Œè¯·ä¸è¦è¾“å‡ºä»»ä½•å“ç‰Œã€‚
- å¦‚æœæ²¡æœ‰åœ¨ç”»é¢ä¸­æ‰¾åˆ°ä»»ä½•æ ¸å¿ƒå“ç‰Œï¼Œè¯·ç›´æ¥è¾“å‡º "æ— "ã€‚

# **è¾“å‡ºæ ¼å¼**
- å¦‚æœæ£€æµ‹åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå“ç‰Œï¼Œè¯·ç”¨é€—å·åˆ†éš”è¿”å›ï¼Œä¾‹å¦‚: "å¯èµ‹, illuma"
- å¦‚æœæœªæ£€æµ‹åˆ°ä»»ä½•æ ¸å¿ƒå“ç‰Œï¼Œè¯·è¾“å‡º: "æ— \"""",

        # ğŸ¤ DeepSeekè¯­éŸ³åˆ†æpromptï¼ˆä¸“ä¸ºç‰‡æ®µçº§åˆ«ä¼˜åŒ–ï¼‰
        "deepseek_audio_segment": f"""ä½ æ˜¯ä¸“ä¸šçš„æ¯å©´äº§å“è¯­éŸ³ç‰‡æ®µåˆ†æå¸ˆã€‚è¯·åˆ†æå•ä¸ªè§†é¢‘ç‰‡æ®µçš„è¯­éŸ³è½¬å½•å†…å®¹ï¼Œä¸“æ³¨æå–ç‰‡æ®µçº§åˆ«çš„è¯­ä¹‰æ ‡ç­¾ã€‚

# **ğŸ¯ ç‰‡æ®µåˆ†æç›®æ ‡**
ä»å•ä¸ªè§†é¢‘ç‰‡æ®µï¼ˆé€šå¸¸5-15ç§’ï¼‰çš„è¯­éŸ³è½¬å½•ä¸­æå–æœ‰ä»·å€¼çš„è¯­ä¹‰ä¿¡æ¯ï¼ŒæŒ‰é‡è¦æ€§æ’åºï¼š

# **ğŸ·ï¸ ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šå“ç‰Œå’Œäº§å“ç›¸å…³å†…å®¹**
- **å“ç‰Œè¯†åˆ«**: ä¸¥æ ¼é™åˆ¶åœ¨æ ¸å¿ƒå“ç‰Œåˆ—è¡¨ï¼š{', '.join(core_brands)}
- **äº§å“ç›¸å…³**: å¥¶ç²‰ã€å¥¶ç²‰ç½ã€å¥¶ç“¶ã€é…æ–¹å¥¶ã€A2å¥¶æºã€DHAã€HMOã€è¥å…»æˆåˆ†
- **äº§å“è¡Œä¸º**: å†²æ³¡ã€å–‚å…»ã€é¥®ç”¨ã€æ¨èã€ä»‹ç»

# **ğŸ˜Š ç¬¬äºŒä¼˜å…ˆçº§ï¼šå³æ—¶æƒ…ç»ªå’Œååº”**
- **ç‰‡æ®µæƒ…ç»ª**: ä¸“æ³¨äºè¯¥ç‰‡æ®µä¸­è¡¨è¾¾çš„å…·ä½“æƒ…ç»ªçŠ¶æ€
- **æƒ…ç»ªè¯æ±‡**: {', '.join(emotions)}
- **ååº”è¯æ±‡**: æ»¡æ„ã€ä¸æ»¡ã€æƒŠå–œã€æ‹…å¿§ã€å®‰å¿ƒã€ç–‘è™‘

# **ğŸ¬ ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šç‰‡æ®µåœºæ™¯å’Œè¡Œä¸º**
- **åœºæ™¯æè¿°**: è¯¥ç‰‡æ®µå‘ç”Ÿçš„å…·ä½“åœºæ™¯
- **è¡Œä¸ºåŠ¨ä½œ**: ç‰‡æ®µä¸­çš„ä¸»è¦è¡Œä¸ºå’ŒåŠ¨ä½œ
- **å‚ä¸è€…**: å¦ˆå¦ˆã€å®å®ã€åŒ»ç”Ÿã€ä¸“å®¶ç­‰

# **ğŸ“ åˆ†æåŸåˆ™**
1. **ç‰‡æ®µèšç„¦**: åªåˆ†æå½“å‰ç‰‡æ®µå†…å®¹ï¼Œä¸æ¨æµ‹å‰åæ–‡
2. **è¯­ä¹‰æå–**: ä»è¯­éŸ³è¯­ä¹‰ä¸­æå–ï¼Œä¸ä¾èµ–è§†è§‰ä¿¡æ¯
3. **æ ‡ç­¾ç®€æ´**: æ¯ä¸ªç±»åˆ«è¾“å‡ºæœ€æ ¸å¿ƒçš„1-3ä¸ªæ ‡ç­¾
4. **ç½®ä¿¡åº¦**: åªè¾“å‡ºæœ‰æŠŠæ¡çš„æ ‡ç­¾ï¼Œä¸ç¡®å®šçš„å†…å®¹ä¸è¾“å‡º

**è¾“å‡ºæ ¼å¼ï¼š**
product_mentions: [äº§å“ç›¸å…³æ ‡ç­¾ï¼Œå¦‚"å¥¶ç²‰å†²æ³¡"ã€"A2å¥¶æº"]
brand_mentions: [å“ç‰Œåç§°æˆ–"æ— "]
emotion_expression: [æƒ…ç»ªè¡¨è¾¾ï¼Œå¦‚"æ»¡æ„"ã€"æ‹…å¿ƒ"]
action_description: [è¡Œä¸ºæè¿°ï¼Œå¦‚"å–‚å…»è¿‡ç¨‹"ã€"äº§å“ä»‹ç»"]
scene_context: [åœºæ™¯èƒŒæ™¯ï¼Œå¦‚"å®¶ä¸­å¨æˆ¿"ã€"åŒ»é™¢å’¨è¯¢"]""",

        # ğŸ¯ DashScopeè½¬å½•prompt
        "dashscope_transcription": """å°†éŸ³é¢‘å†…å®¹è½¬å½•ä¸ºä¸­æ–‡æ–‡å­—ï¼Œæ³¨æ„ï¼š
1. ä¿æŒæ¯å©´è¡Œä¸šä¸“ä¸šè¯æ±‡å‡†ç¡®æ€§
2. æ­£ç¡®è¯†åˆ«å“ç‰Œåç§°å‘éŸ³
3. ä¿ç•™è¯­æ°”è¯å’Œæƒ…æ„Ÿè¡¨è¾¾
4. è¾“å‡ºæ ‡å‡†ä¸­æ–‡æ–‡æœ¬"""
    }

def get_output_config() -> Dict[str, Any]:
    """è·å–è¾“å‡ºé…ç½®"""
    
    # è·å–é¡¹ç›®æ ¹ç›®å½•
    project_root = Path(__file__).parent.parent
    
    # è·å–é¡¹ç›®é…ç½®
    try:
        config = get_project_config()
    except:
        config = {}
    
    # åŸºç¡€ç›®å½•é…ç½®
    output_dir = config.get("output_dir", "results")
    cache_dir = config.get("cache_dir", "cache")
    temp_dir = config.get("temp_dir", "temp")
    logs_dir = config.get("logs_dir", "logs")
    
    return {
        "output_dir": str(project_root / output_dir),
        "cache_dir": str(project_root / cache_dir),
        "temp_dir": str(project_root / temp_dir),
        "logs_dir": str(project_root / logs_dir),
        "json_dir": str(project_root / output_dir / "json"),
        "summary_dir": str(project_root / output_dir / "summary"),
        "detailed_dir": str(project_root / output_dir / "detailed")
    }

def validate_config() -> bool:
    """éªŒè¯é…ç½®æ˜¯å¦æœ‰æ•ˆ"""
    try:
        # éªŒè¯APIå¯†é’¥
        api_keys = get_api_keys()
        if not any(api_keys.values()):
            logger.error("æœªé…ç½®ä»»ä½•APIå¯†é’¥")
            return False
        
        # éªŒè¯è¾“å‡ºç›®å½•
        output_config = get_output_config() 
        for dir_key, dir_path in output_config.items():
            if dir_key.endswith("_dir"):
                try:
                    Path(dir_path).mkdir(parents=True, exist_ok=True)
                except Exception as e:
                    logger.error(f"æ— æ³•åˆ›å»ºç›®å½• {dir_path}: {e}")
                    return False
        
        logger.info("âœ… é…ç½®éªŒè¯é€šè¿‡")
        return True
        
    except Exception as e:
        logger.error(f"é…ç½®éªŒè¯å¤±è´¥: {e}")
        return False 